"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
self["webpackHotUpdate_N_E"]("src/middleware",{

/***/ "(middleware)/./src/utils/analytics.ts":
/*!********************************!*\
  !*** ./src/utils/analytics.ts ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   Analytics: () => (/* binding */ Analytics),\n/* harmony export */   analytics: () => (/* binding */ analytics)\n/* harmony export */ });\n/* harmony import */ var _lib_redis__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @/lib/redis */ \"(middleware)/./src/lib/redis.ts\");\n/* harmony import */ var _utils__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @/utils */ \"(middleware)/./src/utils/index.ts\");\n/* harmony import */ var _barrel_optimize_names_parse_date_fns__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! __barrel_optimize__?names=parse!=!date-fns */ \"(middleware)/./node_modules/date-fns/parse.js\");\n\n\n\nclass Analytics {\n    constructor(opts){\n        this.retention = 60 * 60 * 24 * 7;\n        if (opts?.retention) this.retention = opts.retention;\n    }\n    async track(namespace, event = {}, opts) {\n        let key = `analytics::${namespace}`;\n        if (!opts?.persist) {\n            key += `::${(0,_utils__WEBPACK_IMPORTED_MODULE_1__.getDate)()}`;\n        }\n        // db call to persist this event\n        await _lib_redis__WEBPACK_IMPORTED_MODULE_0__.redis.hincrby(key, JSON.stringify(event), 1);\n        if (!opts?.persist) await _lib_redis__WEBPACK_IMPORTED_MODULE_0__.redis.expire(key, this.retention);\n    }\n    async retrieveDays(namespace, nDays) {\n        const promises = [];\n        for(let i = 0; i < nDays; i++){\n            const formattedDate = (0,_utils__WEBPACK_IMPORTED_MODULE_1__.getDate)(i);\n            const promise = analytics.retrieve(namespace, formattedDate);\n            promises.push(promise);\n        }\n        const fetched = await Promise.all(promises);\n        const data = fetched.sort((a, b)=>{\n            if ((0,_barrel_optimize_names_parse_date_fns__WEBPACK_IMPORTED_MODULE_2__.parse)(a.date, \"dd/MM/yy\", new Date()) > (0,_barrel_optimize_names_parse_date_fns__WEBPACK_IMPORTED_MODULE_2__.parse)(b.date, \"dd/MMA/yy\", new Date())) {\n                return 1;\n            } else {\n                return -1;\n            }\n        });\n        return data;\n    }\n    async retrieve(namespace, data) {\n        const res = await _lib_redis__WEBPACK_IMPORTED_MODULE_0__.redis.hgetall(`analytics::${namespace}::${data}`);\n        return {\n            date,\n            events: Object.entries(res ?? []).map(([key, value])=>({\n                    [key]: Number(value)\n                }))\n        };\n    }\n}\nconst analytics = new Analytics();\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKG1pZGRsZXdhcmUpLy4vc3JjL3V0aWxzL2FuYWx5dGljcy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFvQztBQUNGO0FBQ0Q7QUFVMUIsTUFBTUc7SUFHWEMsWUFBWUMsSUFBb0IsQ0FBRTthQUYxQkMsWUFBb0IsS0FBSyxLQUFLLEtBQUs7UUFHekMsSUFBSUQsTUFBTUMsV0FBVyxJQUFJLENBQUNBLFNBQVMsR0FBR0QsS0FBS0MsU0FBUztJQUN0RDtJQUVBLE1BQU1DLE1BQU1DLFNBQWlCLEVBQUVDLFFBQWdCLENBQUMsQ0FBQyxFQUFFSixJQUFtQixFQUFFO1FBQ3RFLElBQUlLLE1BQU0sQ0FBQyxXQUFXLEVBQUVGLFVBQVUsQ0FBQztRQUVuQyxJQUFJLENBQUNILE1BQU1NLFNBQVM7WUFDbEJELE9BQU8sQ0FBQyxFQUFFLEVBQUVULCtDQUFPQSxHQUFHLENBQUM7UUFDekI7UUFFQSxnQ0FBZ0M7UUFDaEMsTUFBTUQsNkNBQUtBLENBQUNZLE9BQU8sQ0FBQ0YsS0FBS0csS0FBS0MsU0FBUyxDQUFDTCxRQUFRO1FBQ2hELElBQUksQ0FBQ0osTUFBTU0sU0FBUyxNQUFNWCw2Q0FBS0EsQ0FBQ2UsTUFBTSxDQUFDTCxLQUFLLElBQUksQ0FBQ0osU0FBUztJQUM1RDtJQUVBLE1BQU1VLGFBQWFSLFNBQWlCLEVBQUVTLEtBQWEsRUFBRTtRQUVuRCxNQUFNQyxXQUErQixFQUFFO1FBRXZDLElBQUssSUFBSUMsSUFBSSxHQUFHQSxJQUFJRixPQUFPRSxJQUFLO1lBQzlCLE1BQU1DLGdCQUFnQm5CLCtDQUFPQSxDQUFDa0I7WUFDOUIsTUFBTUUsVUFBVUMsVUFBVUMsUUFBUSxDQUFDZixXQUFXWTtZQUM5Q0YsU0FBU00sSUFBSSxDQUFDSDtRQUNoQjtRQUVBLE1BQU1JLFVBQVUsTUFBTUMsUUFBUUMsR0FBRyxDQUFDVDtRQUVsQyxNQUFNVSxPQUFPSCxRQUFRSSxJQUFJLENBQUMsQ0FBQ0MsR0FBR0M7WUFDNUIsSUFDRTdCLDRFQUFLQSxDQUFDNEIsRUFBRUUsSUFBSSxFQUFFLFlBQVksSUFBSUMsVUFDOUIvQiw0RUFBS0EsQ0FBQzZCLEVBQUVDLElBQUksRUFBRSxhQUFhLElBQUlDLFNBQy9CO2dCQUNBLE9BQU87WUFDVCxPQUFPO2dCQUNMLE9BQU8sQ0FBQztZQUNWO1FBQ0Y7UUFFQSxPQUFPTDtJQUNUO0lBRUEsTUFBTUwsU0FBU2YsU0FBaUIsRUFBRW9CLElBQVksRUFBRTtRQUM5QyxNQUFNTSxNQUFNLE1BQU1sQyw2Q0FBS0EsQ0FBQ21DLE9BQU8sQ0FDN0IsQ0FBQyxXQUFXLEVBQUUzQixVQUFVLEVBQUUsRUFBRW9CLEtBQUssQ0FBQztRQUdwQyxPQUFPO1lBQ0xJO1lBQ0FJLFFBQVFDLE9BQU9DLE9BQU8sQ0FBQ0osT0FBTyxFQUFFLEVBQUVLLEdBQUcsQ0FBQyxDQUFDLENBQUM3QixLQUFLOEIsTUFBTSxHQUFNO29CQUN2RCxDQUFDOUIsSUFBSSxFQUFFK0IsT0FBT0Q7Z0JBQ2hCO1FBQ0Y7SUFDRjtBQUNGO0FBRU8sTUFBTWxCLFlBQVksSUFBSW5CLFlBQVkiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9fTl9FLy4vc3JjL3V0aWxzL2FuYWx5dGljcy50cz81YmUyIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJlZGlzIH0gZnJvbSBcIkAvbGliL3JlZGlzXCI7XG5pbXBvcnQgeyBnZXREYXRlIH0gZnJvbSBcIkAvdXRpbHNcIjtcbmltcG9ydCB7IHBhcnNlIH0gZnJvbSBcImRhdGUtZm5zXCI7XG5cbnR5cGUgQW5hbHl0aWNzQXJncyA9IHtcbiAgcmV0ZW50aW9uPzogbnVtYmVyO1xufTtcblxudHlwZSBUcmFja09wdGlvbnMgPSB7XG4gIHBlcnNpc3Q/OiBib29sZWFuO1xufTtcblxuZXhwb3J0IGNsYXNzIEFuYWx5dGljcyB7XG4gIHByaXZhdGUgcmV0ZW50aW9uOiBudW1iZXIgPSA2MCAqIDYwICogMjQgKiA3O1xuXG4gIGNvbnN0cnVjdG9yKG9wdHM/OiBBbmFseXRpY3NBcmdzKSB7XG4gICAgaWYgKG9wdHM/LnJldGVudGlvbikgdGhpcy5yZXRlbnRpb24gPSBvcHRzLnJldGVudGlvbjtcbiAgfVxuXG4gIGFzeW5jIHRyYWNrKG5hbWVzcGFjZTogc3RyaW5nLCBldmVudDogb2JqZWN0ID0ge30sIG9wdHM/OiBUcmFja09wdGlvbnMpIHtcbiAgICBsZXQga2V5ID0gYGFuYWx5dGljczo6JHtuYW1lc3BhY2V9YDtcblxuICAgIGlmICghb3B0cz8ucGVyc2lzdCkge1xuICAgICAga2V5ICs9IGA6OiR7Z2V0RGF0ZSgpfWA7XG4gICAgfVxuXG4gICAgLy8gZGIgY2FsbCB0byBwZXJzaXN0IHRoaXMgZXZlbnRcbiAgICBhd2FpdCByZWRpcy5oaW5jcmJ5KGtleSwgSlNPTi5zdHJpbmdpZnkoZXZlbnQpLCAxKTtcbiAgICBpZiAoIW9wdHM/LnBlcnNpc3QpIGF3YWl0IHJlZGlzLmV4cGlyZShrZXksIHRoaXMucmV0ZW50aW9uKTtcbiAgfVxuXG4gIGFzeW5jIHJldHJpZXZlRGF5cyhuYW1lc3BhY2U6IHN0cmluZywgbkRheXM6IG51bWJlcikge1xuICAgIHR5cGUgQW5hbHl0aWNzUHJvbWlzZSA9IFJldHVyblR5cGU8dHlwZW9mIGFuYWx5dGljcy5yZXRyaWV2ZT47XG4gICAgY29uc3QgcHJvbWlzZXM6IEFuYWx5dGljc1Byb21pc2VbXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuRGF5czsgaSsrKSB7XG4gICAgICBjb25zdCBmb3JtYXR0ZWREYXRlID0gZ2V0RGF0ZShpKTtcbiAgICAgIGNvbnN0IHByb21pc2UgPSBhbmFseXRpY3MucmV0cmlldmUobmFtZXNwYWNlLCBmb3JtYXR0ZWREYXRlKTtcbiAgICAgIHByb21pc2VzLnB1c2gocHJvbWlzZSk7XG4gICAgfVxuXG4gICAgY29uc3QgZmV0Y2hlZCA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcblxuICAgIGNvbnN0IGRhdGEgPSBmZXRjaGVkLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGlmIChcbiAgICAgICAgcGFyc2UoYS5kYXRlLCBcImRkL01NL3l5XCIsIG5ldyBEYXRlKCkpID5cbiAgICAgICAgcGFyc2UoYi5kYXRlLCBcImRkL01NQS95eVwiLCBuZXcgRGF0ZSgpKVxuICAgICAgKSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBhc3luYyByZXRyaWV2ZShuYW1lc3BhY2U6IHN0cmluZywgZGF0YTogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVkaXMuaGdldGFsbDxSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PihcbiAgICAgIGBhbmFseXRpY3M6OiR7bmFtZXNwYWNlfTo6JHtkYXRhfWBcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRhdGUsXG4gICAgICBldmVudHM6IE9iamVjdC5lbnRyaWVzKHJlcyA/PyBbXSkubWFwKChba2V5LCB2YWx1ZV0pID0+ICh7XG4gICAgICAgIFtrZXldOiBOdW1iZXIodmFsdWUpLFxuICAgICAgfSkpLFxuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGFuYWx5dGljcyA9IG5ldyBBbmFseXRpY3MoKTtcbiJdLCJuYW1lcyI6WyJyZWRpcyIsImdldERhdGUiLCJwYXJzZSIsIkFuYWx5dGljcyIsImNvbnN0cnVjdG9yIiwib3B0cyIsInJldGVudGlvbiIsInRyYWNrIiwibmFtZXNwYWNlIiwiZXZlbnQiLCJrZXkiLCJwZXJzaXN0IiwiaGluY3JieSIsIkpTT04iLCJzdHJpbmdpZnkiLCJleHBpcmUiLCJyZXRyaWV2ZURheXMiLCJuRGF5cyIsInByb21pc2VzIiwiaSIsImZvcm1hdHRlZERhdGUiLCJwcm9taXNlIiwiYW5hbHl0aWNzIiwicmV0cmlldmUiLCJwdXNoIiwiZmV0Y2hlZCIsIlByb21pc2UiLCJhbGwiLCJkYXRhIiwic29ydCIsImEiLCJiIiwiZGF0ZSIsIkRhdGUiLCJyZXMiLCJoZ2V0YWxsIiwiZXZlbnRzIiwiT2JqZWN0IiwiZW50cmllcyIsIm1hcCIsInZhbHVlIiwiTnVtYmVyIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(middleware)/./src/utils/analytics.ts\n");

/***/ })

});